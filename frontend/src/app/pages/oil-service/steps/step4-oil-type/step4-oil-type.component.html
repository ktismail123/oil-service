<div class="max-w-7xl mx-auto">
  <!-- Header Section -->
  <div
    class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-3xl p-6 mb-8 shadow-sm border border-white/20"
  >
    <div
      class="flex lg:flex-row lg:items-center lg:justify-between gap-6"
    >
      <!-- Step Info -->
      <div class="flex items-center gap-4">
        <div
          class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center flex-shrink-0 shadow-lg shadow-blue-500/25"
        >
          <span class="text-white font-bold text-lg">4</span>
        </div>
        <div class="flex-1">
          <h2 class="text-lg md:text-xl font-bold text-gray-900">
            Choose Engine Oil
          </h2>
        </div>
      </div>

      <!-- Search Container and Selected Oil Info -->
      <div class="flex flex-col sm:flex-row gap-4 sm:items-center">
        @if(!selectedOilId()){

        <!-- Search and Filter Container -->
        <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
          <!-- Viscosity Filter Dropdown -->
          <div class="w-full sm:w-auto sm:min-w-[140px]">
            <div class="relative">
              <select
                [(ngModel)]="selectedViscosity"
                class="w-full h-12 px-4 pr-10 bg-white border-2 border-gray-200 rounded-xl text-gray-900 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all duration-200 outline-none text-sm appearance-none cursor-pointer"
              >
                <option value="">All Viscosity</option>
                <option
                  *ngFor="let viscosity of viscosityOptions"
                  [value]="viscosity"
                >
                  {{ viscosity }}
                </option>
              </select>
              <!-- Custom dropdown arrow -->
              <div
                class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"
              >
                <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
              </div>
            </div>
          </div>

          <!-- Search Input -->
          <div class="w-full sm:w-auto sm:min-w-[250px]">
            <div class="relative group">
              <div
                class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
              >
                <i
                  class="fas fa-search text-gray-400 text-sm group-focus-within:text-blue-500 transition-colors duration-200"
                ></i>
              </div>
              <input
                type="text"
                class="w-full h-12 pl-11 pr-11 bg-white border-2 border-gray-200 rounded-xl text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all duration-200 outline-none text-sm"
                placeholder="Search engine oils..."
                [(ngModel)]="searchTerm"
                #searchInput
              />
              <button
                *ngIf="searchInput.value"
                (click)="searchTerm = ''"
                type="button"
                class="absolute inset-y-0 right-0 pr-3 flex items-center group/clear"
              >
                <div
                  class="w-6 h-6 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center transition-all duration-200 group-hover/clear:scale-110"
                >
                  <i class="fas fa-times text-white text-xs"></i>
                </div>
              </button>
            </div>
          </div>

          <!-- Clear Filters Button (shows when any filter is active) -->
          <button
            *ngIf="selectedViscosity"
            (click)="clearAllFilters()"
            type="button"
            class="w-full sm:w-auto px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-xl transition-all duration-200 text-sm border border-gray-200"
          >
            <i class="fas fa-filter-circle-xmark mr-2"></i>
          </button>
        </div>
        }

        <!-- Selected Oil Info -->
        <div
          *ngIf="selectedOilId()"
          class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-3 border border-blue-200 flex-shrink-0"
        >
          <div
            class="font-semibold text-blue-700 text-sm sm:text-base truncate"
          >
            {{ getSelectedOilDetails()?.brand }}
            {{ getSelectedOilDetails()?.grade }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div
    *ngIf="errorMessage()"
    class="mb-8 bg-gradient-to-r from-red-50 to-red-100 border-2 border-red-200 rounded-2xl p-4 shadow-sm"
  >
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div
          class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center flex-shrink-0"
        >
          <i class="fas fa-exclamation-triangle text-white text-sm"></i>
        </div>
        <p class="text-red-800 font-medium">{{ errorMessage() }}</p>
      </div>
      <button
        type="button"
        (click)="errorMessage.set('')"
        class="w-8 h-8 bg-red-200 hover:bg-red-300 rounded-lg flex items-center justify-center transition-colors duration-200"
      >
        <i class="fas fa-times text-red-700 text-sm"></i>
      </button>
    </div>
  </div>

  <!-- Main Configuration Grid -->
  <div
    [ngClass]="
      selectedOilId()
        ? 'grid grid-cols-1 lg:grid-cols-[280px_1fr] xl:grid-cols-[300px_1fr] gap-4 lg:gap-6 mb-8'
        : 'grid grid-cols-1 gap-6 mb-8'
    "
  >
    <!-- Left Sidebar - Compact Configuration -->
    <div class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-1 gap-4">
      <div
        *ngIf="selectedOilId()"
        class="rounded-2xl p-4 shadow-md h-fit bg-white"
      >
        <!-- Header -->
        <div class="flex items-center gap-2 mb-4">
          <div
            class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center"
          >
            <i class="fas fa-calculator text-white text-sm"></i>
          </div>
          <h3 class="text-base font-bold text-gray-900">Configuration</h3>
        </div>

        <!-- Form + Actions container -->
        <div
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 gap-4 items-start"
        >
          <!-- Required Quantity Input -->
          <div>
            <app-form-field
              label="Required Quantity (L)"
              type="number"
              [control]="reqOilQnyForm.get('requiredOilQuantity')!"
              placeholder="5.5"
              fieldId="requiredOilQuantity"
              [required]="true"
              step="0.5"
              min="1"
              max="20"
              (input)="onRequiredQuantityChange()"
            >
            </app-form-field>
          </div>

          <!-- Action Buttons -->
          <div
            class="flex flex-col space-y-2 md:flex-row md:space-y-0 md:mt-7 md:space-x-2 lg:flex-col lg:space-y-2 lg:space-x-0"
          >
            <button
              type="button"
              (click)="showAllOils()"
              class="!w-full md:w-1/2 px-3 py-2 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-medium rounded-lg transition-all duration-200 text-sm"
            >
              <i class="fas fa-list mr-2"></i>
              Show All Oils
            </button>

            <button
              type="button"
              (click)="proceedToNextStep5()"
              class="!w-full md:w-1/2 px-3 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-medium rounded-lg transition-all duration-200 text-sm"
            >
              <i class="fas fa-arrow-right mr-2"></i>
              Next Step
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Content Area -->
    <div class="space-y-6">
      <!-- Package Configuration (when oil selected) -->
      <div
        *ngIf="selectedOilId()"
        class="bg-white rounded-2xl shadow-md overflow-hidden"
      >
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4">
          <div
            class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3"
          >
            <div>
              <h3 class="text-lg font-bold text-white">
                Package Configuration
              </h3>
              <p class="text-blue-100 text-sm">
                {{ getSelectedOilDetails()?.brand }}
                {{ getSelectedOilDetails()?.grade }}
              </p>
            </div>
            <div class="text-left sm:text-right text-white">
              <div class="text-xl font-bold">
                AED
                {{
                  getExtendedSelection(selectedOilId()!).totalPrice.toFixed(2)
                }}
              </div>
              <div class="text-sm text-blue-100">
                {{ getExtendedSelection(selectedOilId()!).totalQuantity }}L
                Total
              </div>
            </div>
          </div>
        </div>

        <!-- Package Options -->
        <div class="p-4 lg:p-6">
          <div
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-4 mb-4"
          >
            <!-- 1L Package -->
            <div
              *ngIf="getSelectedOilDetails()?.package_1l_available"
              class="rounded-xl p-4 border-2 border-gray-200 hover:border-green-300 transition-colors duration-200"
            >
              <div class="text-center mb-3">
                <div
                  class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mx-auto mb-2"
                >
                  <i class="fas fa-oil-can text-green-600 text-lg"></i>
                </div>
                <div class="font-bold text-sm text-gray-900">1L Package</div>
                <div class="text-xs text-green-600 font-medium">
                  AED {{ getSelectedOilDetails()?.price_1l }}
                </div>
              </div>

              <div
                class="flex items-center justify-center gap-3 bg-gray-50 rounded-lg p-2 mb-3"
              >
                <button
                  type="button"
                  (click)="decrease1LPackage(selectedOilId()!)"
                  [disabled]="
                    getExtendedSelection(selectedOilId()!).package1L_count <= 0
                  "
                  class="w-8 h-8 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:bg-gray-200 disabled:cursor-not-allowed flex items-center justify-center transition-all duration-200"
                >
                  <i class="fas fa-minus text-gray-600 text-xs"></i>
                </button>

                <span
                  class="min-w-[2rem] text-center font-bold text-gray-900 text-sm"
                >
                  {{ getExtendedSelection(selectedOilId()!).package1L_count }}
                </span>

                <button
                  type="button"
                  (click)="increase1LPackage(selectedOilId()!)"
                  class="w-8 h-8 bg-white border border-green-300 rounded-md hover:bg-green-50 flex items-center justify-center transition-all duration-200"
                >
                  <i class="fas fa-plus text-green-600 text-xs"></i>
                </button>
              </div>

              <div
                *ngIf="
                  getExtendedSelection(selectedOilId()!).package1L_count > 0
                "
                class="text-center p-2 bg-green-50 rounded-lg border border-green-200"
              >
                <div class="text-xs font-bold text-green-700">
                  AED
                  {{
                    (
                      getExtendedSelection(selectedOilId()!).package1L_count *
                      +(getSelectedOilDetails()?.price_1l || "0")
                    ).toFixed(2)
                  }}
                </div>
                <div class="text-xs text-green-600">
                  ({{
                    getExtendedSelection(selectedOilId()!).package1L_count
                  }}L)
                </div>
              </div>
            </div>

            <!-- 4L Package -->
            <div
              *ngIf="getSelectedOilDetails()?.package_4l_available"
              class="rounded-xl p-4 border-2 border-gray-200 hover:border-blue-300 transition-colors duration-200"
            >
              <div class="text-center mb-3">
                <div
                  class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mx-auto mb-2"
                >
                  <i class="fas fa-oil-can text-blue-600 text-lg"></i>
                </div>
                <div class="font-bold text-sm text-gray-900">4L Package</div>
                <div class="text-xs text-blue-600 font-medium">
                  AED {{ getSelectedOilDetails()?.price_4l }}
                </div>
              </div>

              <div
                class="flex items-center justify-center gap-3 bg-gray-50 rounded-lg p-2 mb-3"
              >
                <button
                  type="button"
                  (click)="decrease4LPackage(selectedOilId()!)"
                  [disabled]="
                    getExtendedSelection(selectedOilId()!).package4L_count <= 0
                  "
                  class="w-8 h-8 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:bg-gray-200 disabled:cursor-not-allowed flex items-center justify-center transition-all duration-200"
                >
                  <i class="fas fa-minus text-gray-600 text-xs"></i>
                </button>

                <span
                  class="min-w-[2rem] text-center font-bold text-gray-900 text-sm"
                >
                  {{ getExtendedSelection(selectedOilId()!).package4L_count }}
                </span>

                <button
                  type="button"
                  (click)="increase4LPackage(selectedOilId()!)"
                  class="w-8 h-8 bg-white border border-blue-300 rounded-md hover:bg-blue-50 flex items-center justify-center transition-all duration-200"
                >
                  <i class="fas fa-plus text-blue-600 text-xs"></i>
                </button>
              </div>

              <div
                *ngIf="
                  getExtendedSelection(selectedOilId()!).package4L_count > 0
                "
                class="text-center p-2 bg-green-50 rounded-lg border border-green-200"
              >
                <div class="text-xs font-bold text-green-700">
                  AED
                  {{
                    (
                      getExtendedSelection(selectedOilId()!).package4L_count *
                      +(getSelectedOilDetails()?.price_4l || "0")
                    ).toFixed(2)
                  }}
                </div>
                <div class="text-xs text-green-600">
                  ({{
                    getExtendedSelection(selectedOilId()!).package4L_count * 4
                  }}L)
                </div>
              </div>
            </div>

            <!-- 5L Package (NEW - First position for prominence) -->
            <div
              *ngIf="getSelectedOilDetails()?.package_5l_available"
              class="rounded-xl p-4 border-2 border-gray-200 hover:border-orange-300 transition-colors duration-200"
            >
              <div class="text-center mb-3">
                <div
                  class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mx-auto mb-2"
                >
                  <i class="fas fa-oil-can text-orange-600 text-lg"></i>
                </div>
                <div class="font-bold text-sm text-gray-900">5L Package</div>
                <div class="text-xs text-orange-600 font-medium">
                  AED {{ getSelectedOilDetails()?.price_5l }}
                </div>
              </div>

              <div
                class="flex items-center justify-center gap-3 bg-gray-50 rounded-lg p-2 mb-3"
              >
                <button
                  type="button"
                  (click)="decrease5LPackage(selectedOilId()!)"
                  [disabled]="
                    getExtendedSelection(selectedOilId()!).package5L_count <= 0
                  "
                  class="w-8 h-8 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:bg-gray-200 disabled:cursor-not-allowed flex items-center justify-center transition-all duration-200"
                >
                  <i class="fas fa-minus text-gray-600 text-xs"></i>
                </button>

                <span
                  class="min-w-[2rem] text-center font-bold text-gray-900 text-sm"
                >
                  {{ getExtendedSelection(selectedOilId()!).package5L_count }}
                </span>

                <button
                  type="button"
                  (click)="increase5LPackage(selectedOilId()!)"
                  class="w-8 h-8 bg-white border border-orange-300 rounded-md hover:bg-orange-50 flex items-center justify-center transition-all duration-200"
                >
                  <i class="fas fa-plus text-orange-600 text-xs"></i>
                </button>
              </div>

              <div
                *ngIf="
                  getExtendedSelection(selectedOilId()!).package5L_count > 0
                "
                class="text-center p-2 bg-green-50 rounded-lg border border-green-200"
              >
                <div class="text-xs font-bold text-green-700">
                  AED
                  {{
                    (
                      getExtendedSelection(selectedOilId()!).package5L_count *
                      +(getSelectedOilDetails()?.price_5l || "0")
                    ).toFixed(2)
                  }}
                </div>
                <div class="text-xs text-green-600">
                  ({{
                    getExtendedSelection(selectedOilId()!).package5L_count * 5
                  }}L)
                </div>
              </div>
            </div>

            <!-- Bulk Option -->
            <div
              *ngIf="
                getSelectedOilDetails()?.bulk_available &&
                getSelectedOilDetails()?.price_per_liter !== 0.0
              "
              class="rounded-xl p-4 border-2 border-gray-200 hover:border-purple-300 transition-colors duration-200"
            >
              <div class="text-center mb-3">
                <div
                  class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mx-auto mb-2"
                >
                  <i class="fas fa-drum text-purple-600 text-lg"></i>
                </div>
                <div class="font-bold text-sm text-gray-900">Bulk Option</div>
                <div class="text-xs text-purple-600 font-medium">
                  AED {{ getSelectedOilDetails()?.price_per_liter }}/L
                </div>
              </div>

              <input
                type="number"
                [value]="getExtendedSelection(selectedOilId()!).bulkQuantity"
                (input)="onBulkQuantityChange(selectedOilId()!, $event)"
                placeholder="0"
                step="0.5"
                min="0"
                class="w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-200 outline-none text-center font-medium text-sm mb-3"
              />

              <div
                *ngIf="getExtendedSelection(selectedOilId()!).bulkQuantity > 0"
                class="text-center p-2 bg-green-50 rounded-lg border border-green-200"
              >
                <div class="text-xs font-bold text-green-700">
                  AED
                  {{
                    (
                      getExtendedSelection(selectedOilId()!).bulkQuantity *
                      +(getSelectedOilDetails()?.price_per_liter || "0")
                    ).toFixed(2)
                  }}
                </div>
                <div class="text-xs text-green-600">
                  ({{ getExtendedSelection(selectedOilId()!).bulkQuantity }}L)
                </div>
              </div>
            </div>
          </div>

          <!-- Status Summary -->
          <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg p-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600 font-medium">Breakdown:</span>
                <span class="font-bold text-gray-900">{{
                  getPackageBreakdown(selectedOilId()!)
                }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600 font-medium">Status:</span>
                <span
                  class="font-bold"
                  [class.text-green-600]="
                    getQuantityStatus(selectedOilId()!).includes('✓')
                  "
                  [class.text-orange-600]="
                    getQuantityStatus(selectedOilId()!).includes('extra')
                  "
                  [class.text-red-600]="
                    getQuantityStatus(selectedOilId()!).includes('short')
                  "
                >
                  {{ getQuantityStatus(selectedOilId()!) }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Oil Types Selection Grid -->
      <div *ngIf="!selectedOilId()">
        <div
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-4"
        >
          <div
            *ngFor="let oil of getFilteredOils()"
            class="group relative bg-white border-2 rounded-2xl p-5 cursor-pointer transition-all duration-300 hover:shadow-lg hover:-translate-y-1"
            [class]="
              selectedOilId() === oil.id
                ? 'border-blue-500 bg-blue-50 shadow-lg shadow-blue-500/20 ring-4 ring-blue-500/10'
                : 'border-gray-200 hover:border-gray-300'
            "
            (click)="selectOilType(oil.id)"
          >
            <!-- Selection Indicator -->
            <div class="absolute top-4 right-4">
              <div
                class="w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all duration-200"
                [class]="
                  selectedOilId() === oil.id
                    ? 'bg-blue-500 border-blue-500'
                    : 'border-gray-300 group-hover:border-gray-400'
                "
              >
                <i
                  *ngIf="selectedOilId() === oil.id"
                  class="fas fa-check text-white text-xs"
                ></i>
              </div>
            </div>

            <!-- Oil Info -->
            <div class="pr-8 space-y-3">
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center flex-shrink-0"
                >
                  <i class="fas fa-oil-can text-orange-600 text-lg"></i>
                </div>
                <div class="min-w-0">
                  <div class="font-bold text-base text-gray-900 truncate">
                    {{ oil.grade }}
                  </div>
                  <div class="text-sm text-gray-600 truncate">
                    {{ oil.brand }}
                  </div>
                </div>
              </div>

              <div class="text-sm font-semibold text-blue-600">
                {{ oil.service_interval }} KM
              </div>

              <!-- Package Availability with 5L -->
              <div class="flex flex-wrap gap-1">
                <span
                  *ngIf="oil.package_1l_available"
                  class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-medium bg-green-100 text-green-800"
                >
                  1L: {{ oil.price_1l }}
                </span>
                <span
                  *ngIf="oil.package_4l_available"
                  class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-medium bg-blue-100 text-blue-800"
                >
                  4L: {{ oil.price_4l }}
                </span>
                <span
                  *ngIf="oil.package_5l_available"
                  class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-medium bg-orange-100 text-orange-800"
                >
                  5L: {{ oil.price_5l }}
                </span>
                <span
                  *ngIf="oil.bulk_available && oil.price_per_liter !== 0.0"
                  class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-medium bg-purple-100 text-purple-800"
                >
                  Bulk: {{ oil.price_per_liter }}/L
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="getFilteredOils().length === 0 && oilTypes.length > 0">
        <div
          class="bg-white rounded-3xl border-2 border-dashed border-gray-200 p-16 text-center"
        >
          <div
            class="w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center mx-auto mb-8"
          >
            <i class="fas fa-filter text-3xl text-gray-400"></i>
          </div>
          <h3 class="text-2xl font-bold text-gray-700 mb-4">
            No Matching Oils Found
          </h3>
          <p class="text-gray-500 max-w-lg mx-auto mb-6">
            No oil types match your current filters. Try adjusting your search
            or viscosity filter.
          </p>
          <button
            (click)="clearAllFilters()"
            type="button"
            class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg transition-all duration-200"
          >
            <i class="fas fa-filter-circle-xmark mr-2"></i>
            Clear All Filters
          </button>
        </div>
      </div>

      <!-- Original Empty State -->
      <div *ngIf="oilTypes.length === 0">
        <div
          class="bg-white rounded-3xl border-2 border-dashed border-gray-200 p-16 text-center"
        >
          <div
            class="w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center mx-auto mb-8"
          >
            <i class="fas fa-oil-can text-3xl text-gray-400"></i>
          </div>
          <h3 class="text-2xl font-bold text-gray-700 mb-4">
            No Oil Types Available
          </h3>
          <p class="text-gray-500 max-w-lg mx-auto">
            No oil types match your selected service interval. Please check your
            previous selections or contact support.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
