<div class="step-content">
  <div class="flex items-center mb-6">
    <div
      class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-4"
    >
      <span class="text-green-600 font-bold">3</span>
    </div>
    <h2 class="text-2xl font-semibold text-gray-800">
      Customer Details & Summary
    </h2>
  </div>

  

  <!-- Action Buttons (visible on screen, hidden when printing) -->
  <div class="text-center mb-6 print:hidden space-y-3">
    <div *ngIf="status() === 'cancelled'" class="bg-red-50 max-w-2xl mx-auto rounded-lg p-4 border border-red-200">
      <div class="flex items-center text-red-800">
        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
        <span class="font-semibold">This booking has been cancelled and cannot be modified.</span>
      </div>
    </div>
    <!-- Button Container -->
    <div class="w-full max-w-2xl mx-auto space-y-4">
      <!-- Buttons Row - Responsive Grid Layout -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 lg:gap-4">
        <!-- Submit Button -->
        <button
          (click)="onSubmitBooking()"
          [disabled]="customerForm.invalid || (billNumber() && !editMode) || status() === 'cancelled' "
          class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition-all duration-200 flex items-center justify-center group transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-green-300"
        >
          <span class="flex items-center justify-center">
            <svg
              class="w-5 h-5 mr-2 transition-transform group-hover:scale-110"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                clip-rule="evenodd"
              ></path>
            </svg>
            {{ buttonText }}
          </span>
        </button>

        <!-- Print Receipt Button -->
        <button
          (click)="printReceipt()"
          [disabled]="customerForm.invalid || !billNumber() || status() === 'cancelled' "
          class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition-all duration-200 flex items-center justify-center group transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-blue-300"
        >
          <span class="flex items-center justify-center">
            <svg
              class="w-5 h-5 mr-2 transition-transform group-hover:scale-110"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z"
                clip-rule="evenodd"
              ></path>
            </svg>
            <span class="hidden sm:inline">Print Receipt</span>
            <span class="sm:hidden">Print</span>
          </span>
        </button>
      </div>
    </div>

    <!-- Form Validation Message -->
    <div *ngIf="customerForm.invalid" class="text-center">
      <p
        class="text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg py-2 px-4 max-w-md mx-auto"
      >
        <svg
          class="w-4 h-4 inline mr-1"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fill-rule="evenodd"
            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
            clip-rule="evenodd"
          ></path>
        </svg>
        Please fill in all required fields before proceeding
      </p>

      <!-- Show specific form errors -->
      <div *ngFor="let error of getFormErrors() | keyvalue" class="mt-2">
        <div *ngFor="let errorMsg of error.value" class="text-xs text-red-500">
          {{ errorMsg }}
        </div>
      </div>
    </div>
  </div>

  <!-- Customer Information Form -->
  <div class="border-b border-dashed border-gray-300 pb-4 mb-4 print:hidden">
    <h3 class="text-sm font-semibold text-gray-700 mb-3 text-center">
      CUSTOMER DETAILS
    </h3>
    <form [formGroup]="customerForm" [ngClass]="status() === 'cancelled' ? 'pointer-events-none' : '' ">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <!-- Plate Number -->
        <div>
          <label class="block text-xs text-gray-500 mb-1"
            >Vehicle Plate Number *</label
          >
          <app-form-field
            [control]="customerForm.get('plateNumber')!"
            placeholder="Enter plate number"
            fieldId="plateNumber"
            [required]="true"
            class="w-full text-sm"
          >
          </app-form-field>
        </div>

        <!-- Mobile Number -->
        <div>
          <label class="block text-xs text-gray-500 mb-1"
            >Mobile Number</label
          >
          <app-form-field
            [type]="'number'"
            [control]="customerForm.get('mobile')!"
            placeholder="Enter mobile number"
            fieldId="customerMobile"
            [required]="true"
            class="w-full text-sm"
          >
          </app-form-field>
        </div>

        <!-- Customer Name -->
        <div>
          <label class="block text-xs text-gray-500 mb-1"
            >Customer Name</label
          >
          <app-form-field
            [control]="customerForm.get('name')!"
            placeholder="Enter customer name"
            fieldId="customerName"
            [required]="true"
            class="w-full text-sm"
          >
          </app-form-field>
        </div>

        <!-- Labour Cost -->
        <div class="w-full flex justify-between gap-3">
          <div class="w-full">
            <label class="block text-xs text-gray-500 mb-1">Labour Cost (AED) *</label>
            <app-form-field
              [type]="'number'"
              [control]="customerForm.get('laborCost')!"
              placeholder="Labour Cost"
              fieldId="laborCost"
              [required]="true"
              class="w-full text-sm"
            >
            </app-form-field>
          </div>
          <div class="w-full">
            <label class="block text-xs text-gray-500 mb-1">Discount (AED)</label>
            <app-form-field
              [type]="'number'"
              [control]="customerForm.get('discount')!"
              placeholder="0.00"
              fieldId="discount"
              [required]="false"
              class="w-full text-sm"
            >
            </app-form-field>
          </div>
        </div>

        <!-- Memo - Full Width -->
        <div class="md:col-span-2">
          <label class="block text-xs text-gray-500 mb-1">
            <i class="fas fa-file-alt mr-1"></i>
            Service Memo
          </label>
          <textarea
            [formControlName]="'memo'"
            rows="3"
            maxlength="500"
            placeholder="Service notes, special instructions, or observations..."
            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500 resize-y"
            [class.border-red-300]="customerForm.get('memo')?.invalid && customerForm.get('memo')?.touched"
            [class.focus:ring-red-500]="customerForm.get('memo')?.invalid && customerForm.get('memo')?.touched"
          >
          </textarea>
          <div class="flex justify-between items-center mt-1 text-xs">
            <span class="text-gray-400"
              >Optional - for technician reference</span
            >
            <span class="text-gray-500 tabular-nums"
              >{{ customerForm.get("memo")?.value?.length || 0 }}/500</span
            >
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Receipt Style Layout -->
<div class="max-w-md mx-auto bg-white shadow-lg p-5" id="receipt-content">
  <!-- Receipt Header -->
  <div class="text-center border-b-2 border-dashed border-black pb-4 mb-4">
    <h1 class="text-2xl font-bold text-black mb-1">TECH LUBE</h1>
    <p class="text-sm font-medium text-black">Premium Auto Service Center</p>
    <p class="text-sm text-black mt-1">
      Tel: {{ environment.contact_number }}
    </p>
    <p class="text-sm text-black">Email: {{ environment.email }}</p>
  </div>

  <!-- Receipt Number & Date -->
  <div class="text-center mb-4">
    <p class="text-sm font-bold text-black">RECEIPT #{{ billNumber() || "---" }}</p>
    <p class="text-sm font-medium text-black">{{ formattedDate }}</p>
  </div>

  <!-- Customer Info -->
  <div class="border-b border-dashed border-black pb-4 mb-4" *ngIf="customerForm.get('name')?.value">
    <h3 class="text-base font-bold text-black mb-3 text-center">
      CUSTOMER DETAILS
    </h3>
    
    <div class="flex justify-between text-sm mb-1">
      <span class="font-medium text-black">Name:</span>
      <span class="font-bold text-black">{{ customerForm.get('name')?.value }}</span>
    </div>
    
    <div class="flex justify-between text-sm mb-1">
      <span class="font-medium text-black">Mobile:</span>
      <span class="font-bold text-black">{{ customerForm.get('mobile')?.value }}</span>
    </div>
    
    <div class="flex justify-between text-sm mb-2">
      <span class="font-medium text-black">Vehicle:</span>
      <span class="font-bold text-black">{{ customerForm.get('plateNumber')?.value }}</span>
    </div>
  </div>

  <!-- Service Details -->
  <div class="border-b border-dashed border-black pb-4 mb-4">
    <h3 class="text-base font-bold text-black mb-3 text-center">
      SERVICE DETAILS
    </h3>

    <!-- Service Type -->
    <div class="flex justify-between text-sm mb-2">
      <span class="font-medium text-black">Service Type:</span>
      <span class="font-bold text-black">Other Service</span>
    </div>
  </div>

  <!-- Items & Services -->
  <div class="border-black pb-4 mb-4">
    <h3 class="text-base font-bold text-black mb-3 text-center">
      ITEMS & SERVICES
    </h3>

    <!-- Oil Filter Service -->
    <div *ngIf="summary().oilFilter" class="mb-3">
      <div class="flex justify-between text-sm">
        <div class="flex-1">
          <p class="font-bold text-black">Oil Filter Service</p>
          <p class="font-medium text-black">{{ summary().oilFilter?.code }} - {{ summary().oilFilter?.brand }}</p>
        </div>
        <div class="text-right">
          <p class="font-bold text-black">
            {{ getOilFilterPriceAndLaborCost() | currency : 'AED ' }}
          </p>
        </div>
      </div>
    </div>

    <!-- Accessories -->
    <div *ngFor="let accessory of summary().accessories" class="mb-3">
      <div class="flex justify-between text-sm">
        <div class="flex-1">
          <p class="font-bold text-black">{{ accessory.name }}</p>
          <p class="font-medium text-black">
            Qty: {{ accessory.quantity || 1 }} x {{ accessory.price | currency : 'AED ' }}
          </p>
        </div>
        <div class="text-right">
          <p class="font-bold text-black">
            {{
              ((accessory.price || 0) * (accessory.quantity || 1)) | currency : 'AED '
            }}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Totals -->
  <div class="space-y-2 mb-4">
    <!-- Discount (if any) -->
    <!-- <div class="flex justify-between text-sm" *ngIf="summary().discount > 0">
      <span class="font-medium text-black">Discount:</span>
      <span class="font-bold text-red-600">
        {{ summary().discount | currency : "AED " }}
      </span>
    </div> -->

    <!-- Subtotal after discount (showing breakdown) -->
    <div class="border-t border-dashed border-black pt-2">
      <div class="flex justify-between text-sm">
        <span class="font-medium text-black">Subtotal:</span>
        <span class="font-bold text-black">{{ summary().itemsSubtotal - summary().vatAmount| currency : "AED " }}</span>
      </div>
      <div class="flex justify-between text-sm">
        <span class="font-medium text-black">VAT (5%):</span>
        <span class="font-bold text-black">{{ summary().vatAmount | currency : "AED " }}</span>
      </div>
    </div>

    <!-- Final Total -->
    <div class="border-t-2 border-dashed border-black pt-2">
      <div class="flex justify-between text-lg font-black">
        <span class="text-black">TOTAL (inc. VAT):</span>
        <span class="text-black">{{ summary().totalAmount | currency : "AED " }}</span>
      </div>
    </div>
  </div>

  <!-- Memo Display (if provided) -->
  <!-- <div class="border-b border-dashed border-black pb-4 mb-4" *ngIf="customerForm.get('memo')?.value && customerForm.get('memo')?.value.trim()">
    <h3 class="text-base font-bold text-black mb-2 text-center">
      SERVICE NOTES
    </h3>
    <p class="text-sm font-medium text-black text-center whitespace-pre-wrap">{{ customerForm.get('memo')?.value }}</p>
  </div> -->

  <!-- Footer -->
  <div
    class="text-center border-t-2 border-dashed border-black pt-4 text-sm"
  >
    <p class="mb-1 font-bold text-black">Thank you for choosing Tech Lube!</p>
    <div class="space-y-1">
      <p class="font-medium text-black">{{environment.website}}</p>
    </div>
  </div>
</div>
</div>